name: .NET Core

on:
  push:
    
jobs:
  build:

    runs-on: ubuntu-latest
    env:
     working_directory: ./AzFuncNotifySlack
     project_directory: ./AzFuncNotifySlack/AzFuncNotifySlack  
       
    steps:
    - uses: actions/checkout@v2      
    - run: |
       git fetch --prune --unshallow
    - name: Get Git Version
      uses: docker://gittools/gitversion:5.0.2-beta1-27-linux-centos-7-netcoreapp2.2
      with:
        args: /github/workspace /nofetch /exec /bin/sh /execargs "-c \"echo $GitVersion_FullSemVer > /github/workspace/version.txt\""
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.101
    - name: Install dependencies
      working-directory: ${{env.working_directory}} 
      run: dotnet restore 
    - name: Build
      working-directory: ${{env.working_directory}} 
      run: dotnet build --configuration Release --no-restore
    - name: Extract Octopus Tools
      working-directory: ${{env.working_directory}} 
      run: |
        mkdir /opt/octo
        cd /opt/octo
        wget -O /opt/octo/octopus.zip https://download.octopusdeploy.com/octopus-tools/7.3.3/OctopusTools.7.3.3.portable.zip
        echo "unzip octopus.zip"
        unzip /opt/octo/octopus.zip
        echo "unzipped octopus.zip"
        chmod +x /opt/octo/octo
        echo "version number"
        echo $(cat ${{ github.workspace }}/version.txt)
    - name: Pack Application
      working-directory: ${{env.working-directory}} 
      run: >-
        /opt/octo/octo pack .
        --outFolder /home/runner/work/AzFuncNotifySlack
        --basePath /home/runner/work/AzFuncNotifySlack/AzureSlackFunction
        --id AwsSamLambda
        --version $(cat ${{ github.workspace }}/version.txt)
        --format zip
    - name: Push to Octopus
      working-directory: ${{env.working-directory}} 
      run: >-
        /opt/octo/octo push
        --server ${{ secrets.OCTOADMINSAMPLE_URL }}
        --apiKey ${{ secrets.OCTOADMINSAMPLE_APIKEY }}
        --package ${{env.working-directory}}/AzureSlackFunction.$(cat ${{ github.workspace }}/version.txt).zip
        --overwrite-mode IgnoreIfExists
